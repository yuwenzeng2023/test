name: Reusable Build & Deploy

on:
  workflow_call:
    inputs:
      script:
        required: true
        type: string

jobs:

  eval:
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.run-script.outputs.result }}
    steps:
      - name: set env
        id: set-env
        run: echo "IMAGE_TAG=${{ github.sha }}" >> $GITHUB_ENV

      - name: Write script file
        run: |
          cat <<'EOF' > script.js
          const userFunc = ${{
            inputs.script
          }};
          const result = userFunc({ env: process.env });
          console.log('[RESULT]', result);
          EOF

      - name: Run script
        id: run-script
        run: |
          node script.js > output.log
          cat output.log
          result=$(grep "\[RESULT\]" output.log | sed 's/\[RESULT\] //')
          echo "result=$result" >> $GITHUB_OUTPUT

  notify:
    runs-on: ubuntu-latest
    needs: [eval]
    steps:
      - name : Notify Deployment
        shell: bash
        run: |
          echo "Deployment result: ${{ needs.eval.outputs.result }}"